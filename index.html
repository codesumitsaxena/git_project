<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Buddy - Voice Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .chat-container {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    #chatBox {
      min-height: 400px;
      max-height: 500px;
      overflow-y: auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .message {
      margin: 15px 0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      animation: slideIn 0.3s ease;
      line-height: 1.5;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      text-align: right;
      border-bottom-right-radius: 4px;
    }
    
    .ai {
      background: #e8f5e9;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    
    .ai strong {
      color: #4CAF50;
    }
    
    .input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    #textInput {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    
    #textInput:focus {
      border-color: #667eea;
    }
    
    button {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    #sendBtn {
      background: #667eea;
      color: white;
    }
    
    #sendBtn:hover {
      background: #5568d3;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    #voiceBtn {
      background: #4CAF50;
      color: white;
      padding: 14px 30px;
      position: relative;
    }
    
    #voiceBtn:hover {
      background: #45a049;
    }
    
    #voiceBtn.listening {
      background: #f44336;
      animation: pulse 1.5s infinite;
    }
    
    #voiceBtn.continuous {
      background: #2196F3;
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
      }
    }
    
    #resetBtn {
      background: #ff9800;
      color: white;
    }
    
    #resetBtn:hover {
      background: #e68900;
    }
    
    .task-list {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .task-list h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    
    .task-card {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 20px;
      border-radius: 15px;
      margin: 15px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      animation: taskAppear 0.5s ease;
      border-left: 5px solid #ff6b6b;
    }
    
    @keyframes taskAppear {
      from {
        opacity: 0;
        transform: scale(0.95) translateX(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateX(0);
      }
    }
    
    .task-card strong {
      font-size: 1.3em;
      color: #333;
      display: block;
      margin-bottom: 12px;
    }
    
    .task-card small {
      color: #666;
      display: block;
      margin: 5px 0;
      font-size: 0.95em;
    }
    
    .task-meta {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .status {
      text-align: center;
      padding: 12px;
      color: white;
      font-weight: 600;
      margin-bottom: 15px;
      border-radius: 12px;
      font-size: 0.95em;
    }
    
    .status.idle {
      background: #2196F3;
    }
    
    .status.listening {
      background: #f44336;
    }
    
    .status.processing {
      background: #ff9800;
    }
    
    .status.continuous {
      background: #2196F3;
    }
    
    #chatBox::-webkit-scrollbar {
      width: 8px;
    }
    
    #chatBox::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    #chatBox::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    
    #chatBox::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .typing-indicator {
      display: none;
      padding: 12px 16px;
      background: #e8f5e9;
      border-radius: 18px;
      max-width: 75px;
      margin: 15px 0;
    }
    
    .typing-indicator span {
      height: 8px;
      width: 8px;
      background: #4CAF50;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }

    .no-tasks {
      color: #999;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ Task Buddy</h1>
      <p>Your personal task assistant - Chat karo aur tasks banao!</p>
    </div>
    
    <div class="chat-container">
      <div id="status" class="status idle">Ready to chat üí¨</div>
      <div id="chatBox">
        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      
      <div class="input-area">
        <input type="text" id="textInput" placeholder="Type anything... 'Hello', 'Create a task', etc." onkeypress="handleKeyPress(event)">
        <button id="sendBtn" onclick="sendText()">üì§</button>
      </div>
      
      <div class="controls">
        <button id="voiceBtn" onclick="toggleVoice()">üé§ Start Voice</button>
        <button id="resetBtn" onclick="resetChat()">üîÑ Reset</button>
      </div>
    </div>
    
    <div class="task-list">
      <h3>üìù Your Tasks</h3>
      <div id="taskList">
        <p class="no-tasks">No tasks yet. Say "Create a task" to get started!</p>
      </div>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://n8n.avertisystems.com/webhook/task-assistant';
    
    let step = 0;
    let taskData = { taskName: '', priority: '', time: '' };
    let isListening = false;
    let continuousMode = false; // NEW: For continuous voice
    let recognition = null;
    let conversationHistory = [];
    let isSpeaking = false; // NEW: To prevent voice feedback loop
    
    // Initialize Speech Recognition
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
      } else if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
      } else {
        return false;
      }
      
      // Support both Hindi and English
      recognition.lang = 'en-IN'; // English with Indian accent (supports Hinglish)
      recognition.continuous = false; // We'll manually restart it
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      recognition.onstart = () => {
        isListening = true;
        if (continuousMode) {
          updateStatus('continuous', 'üé§ Voice Active (Continuous) - Click to Stop');
          document.getElementById('voiceBtn').classList.add('continuous');
          document.getElementById('voiceBtn').classList.remove('listening');
        } else {
          updateStatus('listening', 'Listening... üî¥');
          document.getElementById('voiceBtn').classList.add('listening');
          document.getElementById('voiceBtn').classList.remove('continuous');
        }
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        console.log('Heard:', transcript);
        
        addMessage('user', transcript);
        sendToAI(transcript);
      };
      
      recognition.onerror = (event) => {
        console.error('Speech error:', event.error);
        
        // Auto-restart in continuous mode (except for no-speech timeout)
        if (continuousMode && event.error !== 'no-speech') {
          setTimeout(() => {
            if (continuousMode && !isSpeaking) {
              try {
                recognition.start();
              } catch (e) {
                console.log('Restart prevented:', e);
              }
            }
          }, 500);
        } else {
          isListening = false;
          updateStatus('idle', 'Ready to chat üí¨');
          document.getElementById('voiceBtn').classList.remove('listening', 'continuous');
          document.getElementById('voiceBtn').textContent = 'üé§ Start Voice';
        }
      };
      
      recognition.onend = () => {
        isListening = false;
        
        // Auto-restart in continuous mode after AI response
        if (continuousMode && !isSpeaking) {
          setTimeout(() => {
            if (continuousMode) {
              try {
                recognition.start();
              } catch (e) {
                console.log('Restart prevented:', e);
              }
            }
          }, 1000); // 1 second delay before restarting
        } else {
          updateStatus('idle', 'Ready to chat üí¨');
          document.getElementById('voiceBtn').classList.remove('listening', 'continuous');
          document.getElementById('voiceBtn').textContent = 'üé§ Start Voice';
        }
      };
      
      return true;
    }
    
    function toggleVoice() {
      if (!recognition) {
        const initialized = initSpeechRecognition();
        if (!initialized) {
          alert('Voice not supported. Please use Chrome or Edge browser.');
          return;
        }
      }
      
      if (continuousMode) {
        // Stop continuous mode
        continuousMode = false;
        isListening = false;
        try {
          recognition.stop();
        } catch (e) {
          console.log('Stop error:', e);
        }
        updateStatus('idle', 'Ready to chat üí¨');
        document.getElementById('voiceBtn').classList.remove('listening', 'continuous');
        document.getElementById('voiceBtn').textContent = 'üé§ Start Voice';
      } else {
        // Start continuous mode
        continuousMode = true;
        try {
          recognition.start();
          document.getElementById('voiceBtn').textContent = '‚èπÔ∏è Stop Voice';
        } catch (error) {
          console.error('Error:', error);
        }
      }
    }
    
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendText();
      }
    }
    
    function sendText() {
      const input = document.getElementById('textInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      addMessage('user', message);
      sendToAI(message);
      input.value = '';
    }
    
    async function sendToAI(message) {
      updateStatus('processing', 'Thinking... ü§î');
      showTypingIndicator();
      
      // Add to conversation history
      conversationHistory.push({
        role: 'user',
        content: message
      });
      
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            step: step,
            taskData: taskData,
            conversationHistory: conversationHistory,
            sessionId: 'user-' + Date.now()
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('AI Response:', data);
        
        hideTypingIndicator();
        
        // Get AI response
        const aiText = data.aiResponse || data.response || 'Sorry, I did not understand.';
        
        // Add to conversation history
        conversationHistory.push({
          role: 'assistant',
          content: aiText
        });
        
        addMessage('ai', aiText);
        
        // Speak the response
        await speak(aiText);
        
        // Update state
        step = data.nextStep || step;
        taskData = data.taskData || taskData;
        
        console.log('Step:', step, 'Task Data:', taskData, 'Is Complete:', data.isComplete);
        
        // ‚úÖ FIX: Check if task is complete and display it
        if (data.isComplete === true && data.finalTask) {
          console.log('Task Complete! Displaying task:', data.finalTask);
          displayTask(data.finalTask);
          
          // Reset task data for next task
          setTimeout(() => {
            step = 0;
            taskData = { taskName: '', priority: '', time: '' };
            console.log('Task data reset for next task');
          }, 1000);
        }
        
        // Resume listening in continuous mode
        if (continuousMode) {
          updateStatus('continuous', 'üé§ Voice Active (Continuous) - Click to Stop');
        } else {
          updateStatus('idle', 'Ready to chat üí¨');
        }
        
      } catch (error) {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessage('ai', '‚ö†Ô∏è Connection error. Please check your internet or webhook URL.');
        updateStatus('idle', 'Ready to chat üí¨');
      }
    }
    
    function addMessage(type, text) {
      const chatBox = document.getElementById('chatBox');
      const div = document.createElement('div');
      div.className = `message ${type}`;
      
      if (type === 'ai') {
        div.innerHTML = `<strong>ü§ñ Task Buddy:</strong> ${text}`;
      } else {
        div.innerHTML = text;
      }
      
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    function showTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'block';
      document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
    }
    
    function hideTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'none';
    }
    
    function speak(text) {
      return new Promise((resolve) => {
        isSpeaking = true;
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-IN'; // English-India (supports Hinglish)
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        utterance.onend = () => {
          isSpeaking = false;
          resolve();
        };
        
        utterance.onerror = () => {
          isSpeaking = false;
          resolve();
        };
        
        speechSynthesis.speak(utterance);
      });
    }
    
    // ‚úÖ FIX: Proper task display function
    function displayTask(task) {
      const taskList = document.getElementById('taskList');
      
      console.log('Displaying task on frontend:', task);
      
      // Remove "no tasks" message if exists
      const noTasksMsg = taskList.querySelector('.no-tasks');
      if (noTasksMsg) {
        noTasksMsg.remove();
      }
      
      // Create task card
      const div = document.createElement('div');
      div.className = 'task-card';
      div.innerHTML = `
        <strong>üìå ${task.taskName}</strong>
        <div class="task-meta">
          <small>‚ö° Priority: <strong>${task.priority}</strong></small>
          <small>‚è±Ô∏è Time: <strong>${task.time}</strong></small>
        </div>
        <small style="margin-top: 10px;">üìÖ Created: ${new Date(task.createdAt).toLocaleString('en-IN')}</small>
      `;
      
      // Add to list
      taskList.appendChild(div);
      
      // Scroll to show new task
      div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      console.log('‚úÖ Task added to frontend!');
    }
    
    function updateStatus(type, message) {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
    }
    
    function resetChat() {
      step = 0;
      taskData = { taskName: '', priority: '', time: '' };
      conversationHistory = [];
      continuousMode = false;
      
      if (recognition && isListening) {
        try {
          recognition.stop();
        } catch (e) {
          console.log('Stop error on reset:', e);
        }
      }
      
      document.getElementById('chatBox').innerHTML = '<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>';
      document.getElementById('voiceBtn').classList.remove('listening', 'continuous');
      document.getElementById('voiceBtn').textContent = 'üé§ Start Voice';
      
      const greeting = 'Hello! I am Task Buddy. Ask me anything or say "create a task"! üòä';
      addMessage('ai', greeting);
      speak(greeting);
      updateStatus('idle', 'Ready to chat üí¨');
    }
    
    // Initial setup
    window.onload = () => {
      // Request mic permission
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(() => {
          console.log('‚úÖ Microphone permission granted');
          initSpeechRecognition();
        })
        .catch((error) => {
          console.log('‚ùå Mic permission denied:', error);
          alert('Please allow microphone access for voice features to work.');
        });
      
      const greeting = 'Hello! I am Task Buddy. Ask me anything or say "create a task"! üòä';
      addMessage('ai', greeting);
      speak(greeting);
    };
  </script>
</body>
</html>